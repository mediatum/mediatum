<div class="mediatum_clean-container" metal:define-macro="edit_tabs" >
    <ul class="mediatum_nav">
        <tal:block tal:repeat="navitem python:menu">
        <!-- Main Menu -->
        <li tal:condition="python:len(navitem.getItemList())==0" tal:attributes="class python:{0:None,1:'selected'}[navitem.name==breadcrumbs[0]]">
            <a i18n:translate="" tal:content="python:u'tab_{}'.format(navitem.getName())"
            tal:attributes="href python:u'?id={}&tab={}'.format(idstr, navitem.getName());class python:u'mediatum_img_nav mediatum_img_{}'.format(navitem.getName())"/>
        </li>

        <li tal:condition="python:len(navitem.getItemList())>0" tal:attributes="class python:{0:None,1:'selected'}[navitem.name==breadcrumbs[0]]">
            <a tal:condition="python:len(navitem.getItemList())==0" tal:attributes="class python:{0:None,1:'selected'}[navitem.name==breadcrumbs[0]]; href python:navitem.link; target python:navitem.target" i18n:translate="" tal:content="python:u'tab_{}'.format(navitem.name)">TEXT</a>
            <tal:block tal:condition="python:len(navitem.getItemList())>0">
                <a tal:attributes="class python:u'mediatum_img_nav mediatum_img_{}'.format(navitem.getName()); target python:navitem.target" i18n:translate="" tal:content="python:u'tab_{}'.format(navitem.getName())"/>

             <ul>
                <!-- Second Menu -->
                <li tal:repeat="item python:navitem.getItemList()">

                    <tal:block tal:condition="python:len(item.getItemList())>0">
                       <a i18n:translate="" tal:content="python:u'tab_{}'.format(item.getName())" tal:attributes="class python:u'mediatum_img_nav mediatum_img_{}'.format(item.getName())"/>
                    </tal:block>
                    <tal:block tal:condition="python:len(item.getItemList())==0">
                            <a i18n:translate="" tal:content="python:u'tab_{}'.format(item.getName())" tal:attributes="class python:u'mediatum_img_nav mediatum_img_{}'.format(item.getName());href python:u'?id={}&tab={}'.format(idstr, item.getName())"/>
                    </tal:block>
                        <!-- Third Menu -->
                        <tal:block tal:condition="python:len(item.getItemList())>0 and item.getName() != u'menusortnodes'">
                        <ul>
                            <li tal:repeat="item1 python:item.getItemList()">
                            <div>
                            <tal:block tal:condition="python:item1.getName().startswith('mark')==False">
                            <a i18n:translate="" tal:content="python:u'tab_{}'.format(item1.getName())"
                            tal:attributes="id  python:u'{}'.format(item1.getName());href python:u'?id={}&tab={}'.format(idstr, item1.getName());class python:u'mediatum_img_nav mediatum_img_{}'.format(item1.getName())">
                                </a>
                            </tal:block>
                            <tal:block tal:condition="python:item1.getName().startswith('mark')==True">
                            <div i18n:translate="" tal:attributes="tag python:u'{}'.format(item1.getName())" tal:content="python:u'tab_{}'.format(item1.getName())">TEXT</div>
                            </tal:block>
                            </div>
                            </li>
                        </ul>
                        </tal:block>

                        <tal:block tal:condition="python:len(item.getItemList())>0 and item.getName() == u'menusortnodes' and sort_choices">
                            <ul>
                                <li tal:repeat="sortfield python:sort_choices">
                                    <div>
                                        <a i18n:translate="" tal:content="python:u'{}'.format(sortfield.label)" tal:attributes="value python:sortfield.value; href python:u'?id={}&sortfield={}&nodes_per_page={}'.format(idstr, sortfield.value,nodes_per_page)"/>
                                    </div>
                                </li>
                            </ul>
                        </tal:block>
                    </li>
                </ul>
            </tal:block>
        </li>
        </tal:block>
    </ul>


    <div class="mediatum_breadcrumbs">
        <div class="mediatum_breadcrumbs_h">
            <h2>
                <tal:block tal:repeat="item breadcrumbs">
                    <tal:block tal:content="python:u'tab_{}'.format(item.replace('*',''))" i18n:translate="">TEXT</tal:block>
                    <tal:block tal:condition="python:breadcrumbs.index(item)<len(breadcrumbs)-1"> &raquo; </tal:block>
                </tal:block>
            </h2>
        </div>
        <div id="nodeid_" class="mediatum_breadcrumbs_id">
        ID:
             <a target="_blank" tal:condition="python:len(ids)==1" tal:attributes="href python: node_url(ids[0])" tal:content='python:ids[0]'></a>
             <span tal:condition="python:1 < len(ids) <= 5" tal:replace="python:u', '.join(ids)"/>
             <span tal:condition="python:len(ids)>=5" tal:replace="python:u'{}...'.format(u', '.join(ids[:5]))"/>
        </div>
     </div>

</div>


<html metal:define-macro="edit_errorpage">
    <body>
        <h1 tal:content="errormsg"/>
    </body>
</html>


<p metal:define-macro="edit_errortemplate" class="mediatum_templateerror">
    <tal:block i18n:translate="edit_template_error"/><br/><br/>
    <span id="msg" tal:condition="python:e!=''" tal:content="e"/>
</p>


<p metal:define-macro="module_error" class="error" i18n:translate="edit_module_error"><tal:block tal:content="python:module" i18n:name="name"/></p>


<body metal:define-macro="edit_notree_permission" bgcolor="#FFFFFF">
    &nbsp;  no tree permission
</body>

<metal:block metal:define-macro="include_jquery_layout_script_tags">
    <script type="text/javascript" src="/js/jquery.layout.min.js"> </script>
    <script type="text/javascript" src="/js/jquery.layout.resizePaneAccordions-latest.min.js"> </script>
</metal:block>

<metal:block metal:define-macro="edit_main">
    <html>
        <head>
            <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
            <meta content="text/html;charset=UTF-8" http-equiv="content-type">
            <title i18n:translate="edit_main_title">TEXT</title>

            <link id="id_link_fancytree_skin" rel="stylesheet" href="/js/fancytree/src/skin-xp/ui.fancytree.css" />
            <link rel="stylesheet" href="/css/jquery.contextMenu.css" />
            <link rel="stylesheet" href="/css/editor.css" />

            <script type="text/javascript" src="/js/jquery-2.0.3.js"> </script>
            <script type="text/javascript" src="/js/jquery-ui-1.12.1.js"> </script>

            <tal:block metal:use-macro="include_jquery_layout_script_tags"/>

            <script type="text/javascript" src="/js/fancytree/src/jquery.fancytree.js"> </script>
            <script type="text/javascript" src="/js/fancytree/src/jquery.fancytree.persist.js"> </script>
            <script type="text/javascript"src="/js/fancytree/src/jquery.fancytree.filter.js"> </script>
            <script type="text/javascript"src="/js/fancytree/src/jquery.fancytree.dnd.js"> </script>
            <script type="text/javascript"src="/js/fancytree/src/jquery.fancytree.edit.js"> </script>

            <script type="text/javascript" src="/js/fancytree/3rd-party/extensions/contextmenu/jsx/jquery.contextMenu-1.6.5.js"> </script>

            <script type="text/javascript" src="/js/editor.js"> </script>
            <script type="text/javascript" src="/js/admin.js"> </script>

            <script>
              consoledb.group('--- loading contextmenu js ---');
              var ctx_mode = 1;  // 1: on_demand, 2: bind, 3: ui-contextmenu  // now only 1 supported, 2 and 3 abandoned
              var url_ctx_on_demand = "/js/fancytree/3rd-party/extensions/contextmenu/jsx/jquery.fancytree.contextMenu.js";
              var url_ctx_bind = "/js/jquery.contextMenu-custom-abs.js";
              var url_ctx_ui = "//wwwendt.de/tech/demo/jquery-contextmenu/jquery.ui-contextmenu.js";

              if (ctx_mode == 1) {
                  url_ctx = url_ctx_on_demand;
              }
              else if (ctx_mode == 2) {
                  url_ctx = url_ctx_bind;
              }
              else {
                  url_ctx = url_ctx_ui;
              }
              $.getScript( url_ctx, function( data, sStatus, jqxhr ) {
                consoledb.log(sStatus); // Success
                consoledb.log(jqxhr.status ); // 200
                consoledb.log("loaded");
              });
              consoledb.groupEnd('--- loading contextmenu js ---');
            </script>

            <script tal:content="python:u'var user_folders = {};'.format({k: str(folders[k][0].id) for k in folders})">TEXT</script>
            <script tal:content="python:u'var collectionsid = \'{}\';'.format(collectionsid)">TEXT</script>
            <script tal:content="python:u'var containertype2iconpath = {};'.format([[str(i) for i in j] for j in cmenu_iconpaths])">;</script>
            <script tal:content="python:u'var edit_t = \'{}\';'.format(t(language, 'edit_edit_container_node'))">;</script>
            <script tal:content="python:u'var cut_t = \'{}\';'.format(t(language, 'edit_cut_container'))">;</script>
            <script tal:content="python:u'var paste_t = \'{}\';'.format(t(language, 'edit_paste_container_here'))">;</script>
            <script tal:content="python:u'var addcontainer_t = \'{}\';'.format(t(language, 'edit_add_new_container'))">;</script>
            <script tal:content="python:u'var emptybin_t = \'{}\';'.format(t(language, 'edit_empty_recycle_bin'))">;</script>
            <script tal:content="python:u'var delete_t = \'{}\';'.format(t(language, 'edit_delete_container'))">;</script>
            <script tal:content="python:u'var add_col_t = \'{}\';'.format(t(language, 'edit_add_new_collection'))">;</script>

<script type="text/javascript">

// for older browsers such as IE8
// source: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/indexOf#Polyfill
if (!Array.prototype.indexOf) {
    Array.prototype.indexOf = function (searchElement, fromIndex) {
      if ( this === undefined || this === null ) {
        throw new TypeError( '"this" is null or not defined' );
      }

      var length = this.length >>> 0; // Hack to convert object.length to a UInt32

      fromIndex = +fromIndex || 0;

      if (Math.abs(fromIndex) === Infinity) {
        fromIndex = 0;
      }

      if (fromIndex < 0) {
        fromIndex += length;
        if (fromIndex < 0) {
          fromIndex = 0;
        }
      }

      for (;fromIndex < length; fromIndex++) {
        if (this[fromIndex] === searchElement) {
          return fromIndex;
        }
      }

      return -1;
    };
}

// some globals
var idselection = "";
var action = "";
var new_path_endpoint = "";

var flag_cut_mode = false;
var node_to_paste = null;  // node to be moves via context menu
var node_to_paste_classname = '';
var node_to_paste_li = null;

var dummy_temp = null;
var temp_ctx_event = null;
var temp_ctx_trigger = null;

var temp_node = null;

var last_activated_collectiontree_node = null;
var last_activated_hometree_node = null;
var last_activated_node = null;
var last_activated_tree_id_sel = null;

var last_click_event = null;

var tree = gethometree(); // check this

var ctree_dragstart_pnode_key = null;
var ctree_dragstop_pnode_key = null;

var last_ajax_result = null;

var FANCYTREE_KEYBOARD = true;
var FANCYTREE_DEFAULT_ICON = 'img/webtree/directory.gif';

function build_context_menu_items(node, opts) {

    consoledb.groupCollapsed('build_context_menu_items for node ' +  node.key + ', ' + node.title);

    // no contextMenu for disabled nodes or descendants of cut node
    if ( node.li && node.li.classList.contains('fancytree-node-disabled') || (flag_cut_mode && node.isDescendantOf(node_to_paste)) ) {
        return false;
      }

    var create_container_items = {};

    containertype2iconpath.forEach(
          function(t){
            create_container_items['create_container_'+t[0]] = {name: t[1], icon:t[0]};
            }
    );

    var ctx_items = {
            "fornode": {name: node.title+"                                                                        ", disabled: true},
            "edit": {name: edit_t, icon: "edit"},
            "sep1": "---------",
            "submenu_create_container": {
                                          "name": addcontainer_t,
                                          "icon": "add",
                                          "items": create_container_items
                                        },
            "sep2": "---------",
            "cut_container": {name: cut_t, icon: "cut", disabled: flag_cut_mode},
            "paste_container_here": {name: paste_t, icon: "paste", disabled: !flag_cut_mode},
            "delete": {name: delete_t, icon: "delete", accesskey: "l", disabled: flag_cut_mode},
          };

    var special_dir_type = node.data.special_dir_type;

    if (typeof special_dir_type !== "undefined") {
      delete ctx_items["edit"];
      delete ctx_items["cut_container"];
      delete ctx_items["delete"];
    }

    if (special_dir_type === "trash") {
      ctx_items["clear_trash"] = {name: emptybin_t,
                                  icon: '../img/' + node.data.icon}
    }

      ctx_items["sep4"] = "---------";

      consoledb.groupEnd('build_context_menu_items for node ' +  node.key + ', ' + node.title);
      return ctx_items;
};


function showContextMenuForNode(node) {
  try {
    $('#'+node.li.id).contextMenu();
  }
  catch (e) {
    //consoledb.error('trying to showContextMenuForNode:', node, e);
    ;
  }
  var ctx = _tmp_opt_menu;
  return ctx;
}


function hideContextMenuForNode(node) {
  try {
    $('#'+node.li.id).contextMenu('hide');
  }
  catch (e) {
    //consoledb.error('trying to hideContextMenuForNode:', node, e);
    ;
  }
}


function callCommandForVisibleContextMenu(ctx, action, opt) {
  var ctx_data = ctx.data();
  var res = ctx_data.contextMenu.callback(action, opt);
  return res;
}

function callContextMenuCommandForNode(node, action, opt) {
  // opt: optional, may be omitted
  // important: node has to be active
  var ctx = showContextMenuForNode(node);
  var ctx_data = ctx.data();
  var res = ctx_data.contextMenu.callback(action, opt);
  hideContextMenuForNode(node);
  return res;
}

function destroyAllContextMenus() {
  $.contextMenu('destroy');
}

function cd_cmd(node) {
  node.setActive();
  return node;
}

function cmd_cmd(action, opt) {
  return callContextMenuCommandForNode(last_activated_node, action, opt);
}

function getContextMenuCommands() {
  // node has to be active
  var node = last_activated_node;
  var ctx = showContextMenuForNode(node);
  var ctx_data = ctx.data();
  var res = Object.keys(ctx_data.contextMenu.commands)
  hideContextMenuForNode(node);
  return res;
}

function expandAll(fcytree){
  var root = fcytree.getRootNode();
  root.visit(function(node){
    node.setExpanded(true);
  });
}

function expandSubTree(fcynode){
  // call repeatedly to expand levels
  fcynode.setExpanded(true);
  fcynode.visit(function(node){
    node.setExpanded(true);
  });
}

var _tmp_opt_menu = null;

function contextmenue_on_demand(selector, curtree, curtree_node_prefix, curnode) {
  // arguments: '#(h|c)tree-node-'+data.node.key, get(hometree|coltree)(), '(h|c)tree-node-', data.node
  $(function(){
      $.contextMenu({

        selector: selector,  // '#(h|c)tree-node-'+data.node.key

        autoHide: true,
        delay:200,
        zIndex:9999,

        build: function($trigger, e) {

          consoledb.groupCollapsed('contextMenu build for selector "' + selector + '"');
          consoledb.log("ctx_$trigger:", $trigger);
          consoledb.log("ctx_event:", e);

          temp_ctx_event = e;
          temp_ctx_trigger = $trigger;

          var node = curnode;

          // show contextMenu only for the active node
          if (!curnode.isActive()) {curtree.widget.options.keyboard = FANCYTREE_KEYBOARD; return false;};

          //$('.context-menu-list .context-menu-root').focus();
          curtree.widget.options.keyboard = false;

          consoledb.log('ctx menu for node ', node.key, node.title, node);
          consoledb.groupEnd('contextMenu build for selector "' + selector + '"');

          return {

            items: build_context_menu_items(curnode),

            events: {
              hide: function(opt) {current_tree.widget.options.keyboard = FANCYTREE_KEYBOARD;},
              show: function(opt) {
                // show event is executed every time the menu is shown!
                // find all clickable commands and set their title-attribute
                // to their textContent value making the tooltip fulltext
                // may be used to add help info as tooltext

                consoledb.groupCollapsed('contextMenu events show');
                var an = curnode;
                consoledb.log(an.key, an.title, opt);
                consoledb.log('opt: ', opt);
                consoledb.log(opt.$menu);
                _tmp_opt_menu = opt.$menu;

                opt.$menu.find('.context-menu-item > span').attr('title', function() {
                  return $(this).text();
                });
                consoledb.groupEnd('contextMenu events show');
              } // show
            },  // events


            callback: function(action, opts) {

              consoledb.groupCollapsed('--- ctx_callback ---');
              consoledb.log('action cut: ', action);
              consoledb.log(opts);
              consoledb.log('node.key: ' + node.key + ', node.title: ' + node.title);

              var res = false;  // return_value

              var s = "create_container_";
              if (action.substring(0, s.length) === s) {
               var container_type = action.substring(s.length, action.length);
               action = action.substring(0, s.length - 1); // create_container
              }
              hideContextMenuForNode(node); // hide the contextMenu
              switch( action ) {
              case "edit":
                $('.ui-layout-center').attr('src', '/edit/edit_content?id='+node.key+'&tab=metadata');
                res = false;
                break;
              case "create_container":
                consoledb.group('edit.html: create_container');
                node.load(true);
                node.setExpanded();
                addNewContainer(node, container_type);

                consoledb.log("should expand: " + currentpath);
                node.tree.loadKeyPath(currentpath, function(node, status){
                            if(status=="loaded"){
                                node.setExpanded(true);
                            }else if(status=="ok"){
                                node.setActive(true);
                            }
                        });

                consoledb.log(1);
                if (currentpath) {
                    consoledb.log(2);
                    $('.ui-layout-center').attr('src', '/edit/edit_content?id='+new_path_endpoint+'&tab=metadata');
                }
                consoledb.log(3);

                consoledb.groupEnd('edit.html: create_container')
                res = false;
                break;
              case "cut_container":
                consoledb.log('cut node:' + node.key);
                consoledb.log('cut node has focus: ', node.hasFocus());
                node_to_paste = node;
                node_to_paste_li = $(node.li);
                node_to_paste_classname = node_to_paste.li.className;
                consoledb.log('cut node parent.key: ', node_to_paste.parent.key);

                node_to_paste_li.addClass('fancytree-node-disabled');
                flag_cut_mode = true;

                // give tree keyboard focus so that cut mode may be canceled by "ESC" key
                current_tree.widget.options.keyboard = FANCYTREE_KEYBOARD;
                $(last_activated_tree_id_sel + ' .fancytree-container').focus();

                res = false;
                break;
              case "paste_container_here":
                consoledb.log('cut node:' + node.key);
                var src = node_to_paste.parent.key;
                var obj = node_to_paste.key;
                var dest = node.key;
                if(!($.isNumeric(src)))
                {
                    src = node_to_paste.parent.title;
                    consoledb.log("src: ", src);
                };
                if (src == dest) { // nothing to be done: user tries to paste node to parent
                  flag_cut_mode = false;
                  node_to_paste_li.removeClass('fancytree-node-disabled');
                  res = false;
                  break;
                }
                consoledb.log("moving node "+obj+" from parent "+src+" to destination "+dest);
                if (!($.isNumeric(src) && $.isNumeric(obj) && $.isNumeric(dest))) {
                    throw "moving node failed: node id is not an integer";
                };
                ret = edit_action_sync('move', src, obj, dest);
                consoledb.log("edit_action_sync finished: ", ret);
                flag_cut_mode = false;
                new_path_endpoint = obj;
                if (currentpath) {
                    consoledb.log(2);
                    $('.ui-layout-center').attr('src', '/edit/edit_content?id='+new_path_endpoint+'&tab=content');
                }
                consoledb.log("finished paste to: ", dest);
                reloadColTree();
                res = false;
                break;
              case "delete":
                consoledb.log('---> new delete <---');
                currentid = node.key;
                var parent_node = node.getParent();
                consoledb.log('action: '+action+', node'+node+', node.key:'+node.key+', parent_node.key:'+parent_node.key);
                questionOperation('delete'); // removes active node

                res = false;
                break;
              case "clear_trash":
                currentid = node.key;
                var parent_node = node.getParent();
                consoledb.log('action: '+action+', node'+node+', node.key:'+node.key+', parent_node.key:'+parent_node.key);
                questionOperation("clear_trash"); // removes active node
                node.setActive();
                res = false;
                break;
              case "quit":
                res = false;
                break;
              default:
                alert("Todo: appply action '" + action + "' to node " + node + '-' + node.title + '-' + node.key);

                var keys = [];
                for(var k in node.data) keys.push(k);
                alert("total " + keys.length + " keys: " + keys);
                alert("node.title: " + node.title);
                alert("node.key  : " + node.key);
                res = false;
              }
              current_tree.widget.options.keyboard = FANCYTREE_KEYBOARD;
              consoledb.groupEnd('--- ctx_callback ---');
              return res;
           }  // callback

         };  // return
       }  // build
     });  // contextMenu
   });  // function
 }  // contextmenue_on_demand



function contextmenu_collections(selector) {
    consoledb.log("contextmenu_collections collectionsid=", collectionsid);
    $(function(){
      $.contextMenu({

        selector: selector,
        autoHide:true,
        delay:200,
        zIndex:9999,

        build: function($trigger, e) {
            consoledb.log("$trigger:"+$trigger);
            consoledb.log("e:"+e);

             var ctx_items = {
                "edit": {name: edit_t, icon: "edit"},
                "sep1": "---------",
                "create_container_collection": {name: add_col_t, icon: "collection"},
                "sep2": "---------",
                "paste_container_here": {name: paste_t, icon: "paste", disabled: !flag_cut_mode},
            };

            return {
                callback: function(key, options) {
                    consoledb.log("key: " + key);

                    if (key == "edit") {
                        var m = "clicked: " + key;
                        window.console && consoledb.log(m);

                        $('.ui-layout-center').attr('src', '/edit/edit_content?id='+collectionsid+'&tab=metadata');
                      }

                    if (key == "create_container_collection") {
                        var p = "clicked: " + key;
                        window.console && consoledb.log(p);

                        addNewContainerToRoot("collection");
                        reloadColTree();
                        }
                    if (key == "paste_container_here") {
                        consoledb.log("paste_container_here: ", collectionsid);
                        var src = node_to_paste.parent.key;
                        var obj = node_to_paste.key;
                        var dest = collectionsid;
                        if(!($.isNumeric(src)))
                        {
                            src = node_to_paste.parent.title;
                            consoledb.log("src: ", src);
                        };
                        if (src == dest) { // nothing to be done: user tries to paste node to parent
                            flag_cut_mode = false;
                            node_to_paste_li.removeClass('fancytree-node-disabled');
                        }
                        else
                        {
                            consoledb.log("moving node "+obj+" from parent "+src+" to destination "+dest);
                            if (!($.isNumeric(src) && $.isNumeric(obj) && $.isNumeric(dest))) {
                                throw "moving node failed: node id is not an integer";
                            };
                            ret = edit_action_sync('move', src, obj, dest);
                            consoledb.log("edit_action_sync finished: ", ret);
                            flag_cut_mode = false;
                            new_path_endpoint = obj;
                            if (currentpath) {
                                $('.ui-layout-center').attr('src', '/edit/edit_content?id='+new_path_endpoint+'&tab=content');
                            }
                            consoledb.log("finished paste to: ", dest);
                            reloadColTree();
                        }
                    }
                },

                items: ctx_items
              };
          }
      });
  });
}


contextmenu_collections('#collections');


function loadKeyPath_callback_dont_activate(node, status){
    if(status=="loaded"){
        node.setExpanded();
    }else if(status=="ok"){
        //node.setActive();
    }
}

function loadKeyPath_callback_activate(node, status){
    if(status=="loaded"){
        node.setExpanded();
    }else if(status=="ok"){
        node.setActive();
    }
}

function getcoltree() {
    return $("#mediatum_collectionstree").fancytree("getTree");
}

function gethometree() {
    return $("#hometree").fancytree("getTree");
}

function get_expanded_nodes(dtree) {
    var cands = [];

    function fnx(node) {
      if (node.isExpanded()) {
        cands.push(node);
      }
      return true;
    }

    dtree.visit(fnx, false);
    return cands;
};

function expand_nodearray(nodearray) {
    nodearray.forEach(function(node) {
      node.setExpanded(true);
    });
};

function removeByKey(dtree, ckey) {
    var cnode = dtree.getNodeByKey(ckey);
    var pnode = cnode.getParent();
    var pnode_was_expanded = pnode.isExpanded();
    if (pnode) {
      try {

        cnode.li.hidden  = true;
        cnode.remove();

        if (pnode.isExpanded() != pnode_was_expanded) {
          pnode.toggleExpand();
        }
      }
      catch(e) {
        consoledb.log('removeByKey for key='+ckey+' caught: '+e);
      }
    }
  }

function nodearray2keyarray(nodearray) {
    var res = [];
    nodearray.forEach(function(node) {
        res.push(node.key);
    });
    return res;
}

function keyarray2nodearray(dtree, keyarray) {
    var res = [];
    keyarray.forEach(function(key) {
        res.push(dtree.getNodeByKey(key));
    });
    return res;
}

function reloadColTree(){
    $("#mediatum_collectionstree").fancytree("getTree").reload();
}

function reloadHomeTree(){
    $("#hometree").fancytree("getTree").reload();
}


function reloadTree(id){
    var src;
    if(id) {
        src = id;
    } else {
        src = tree.currentfolder;
    }
    this.tree.location.href = "/edit/edit_tree?id="+src+"&r="+""+Math.random()*10000+"#"+src;
}

// source: http://stackoverflow.com/questions/123999/how-to-tell-if-a-dom-element-is-visible-in-the-current-viewport/7557433#7557433
function isElementInViewport(el) {

    //special bonus for those using jQuery
    if (el instanceof jQuery) {
        el = el[0];
    }

    var rect = el.getBoundingClientRect();

    return (
        rect.top >= 0 &&
        rect.left >= 0 &&
        rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) && /*or $(window).height() */
        rect.right <= (window.innerWidth || document.documentElement.clientWidth) /*or $(window).width() */
    );
}


function reloadPage(id, path, tree_selector){
    consoledb.log('web/edit/edit.html: function reloadPage(id, path): id: '+id+', path: '+path);
    var active_accordion = 1;  // #collectionstree
    if (typeof tree_selector === 'undefined' || tree_selector == '#hometree') {
      tree_selector = '#hometree';
      active_accordion = 0;
    }
    action = "";
    idselection = id;
    consoledb.log(path);
    $('.ui-layout-center').attr('src', '/edit/edit_content?id='+id);
    $('.mediatum_accordiontree').accordion("option", "active", active_accordion);
    $(tree_selector).fancytree("getTree").loadKeyPath(path, function(node, status){
        consoledb.log('arguments: ', arguments);
        if(status=="loaded"){
            node.setExpanded(true);
        }else if(status=="ok"){
            node.setActive(true);
            if (!isElementInViewport(node.span)) {
              node.span.scrollIntoView();
            }
        }else{
            var seg = arguments[2], isEndNode = arguments[3];
        }
    });
    try {
      var usedtree = $(tree_selector).fancytree("getTree");
      var an = usedtree.activeNode;
      if (!isElementInViewport(an.span)) { // not needed for fancytree
        an.span.scrollIntoView();
      }
      an.load(forceReload=true);  // fancytree
      an.toggleExpanded();
      an.toggleExpanded();
    }
    catch(e) {
      consoledb.log('tried to reloadChildren(), caught: '+e);
    }

    return false;
}


function addNewContainerToRoot(type){ /* add new container */
    new_path_endpoint = false;
    var ajax_response;
    consoledb.log('addNewContainerToRoot: collectionsid=', collectionsid);
    var parent_id = collectionsid;
    var options = {
          url: '/edit/edit_action?src='+parent_id+'&action=addcontainer&type='+type,
          async: false,
          dataType: 'json',
          success: function (response) {
              ajax_response = response;
              new_path_endpoint = response.key;

              currentpath = response.key;

              consoledb.log('$.ajax returns: '+response);
              consoledb.log('currentpath: '+currentpath);
          },
        };

    $.ajax(options);
}

function addNewContainer(parent_node, type){ /* add new container */
    new_path_endpoint = false;
    var ajax_response;
    var parent_id = parent_node.key;
    consoledb.log('addNewContainer: parent_node.key '+parent_node.key);
    var options = {
          url: '/edit/edit_action?src='+parent_id+'&action=addcontainer&type='+type,
          async: false,
          dataType: 'json',
          success: function (response) {
              ajax_response = response;
              new_path_endpoint = response.key;
              currentpath = currentpath + '/' + response.key;
              consoledb.log('$.ajax returns: '+response);
              consoledb.log('currentpath: '+currentpath);
          },
        };

    $.ajax(options);

    var childnode = ajax_response;
    parent_node.tree.getNodeByKey(parent_id).addChildren([childnode], parent_node.children[0]);
    parent_node.tree.activateKey(new_path_endpoint);
    parent_node.tree.activeNode.data.isFolder = true;
    consoledb.log('activeNode:', parent_node.tree.activeNode.key);
    consoledb.log('parent_node.tree.activeNode.data.isFolder:', parent_node.tree.activeNode.data.isFolder);
}


function questionOperation(type){

    consoledb.group('edit: edit.html: questionOperation('+type+')');

    if (type=='clear_trash'){
        var q = $("#mediatum_clear_trash_question").text();

        if(confirm(q)){

            var htree = $('#hometree').fancytree('getTree');

            var key_to_clear = currentid;

            var node_to_clear = htree.getNodeByKey(key_to_clear);
            var parent_node = node_to_clear.getParent();
            var parent_node_key = parent_node.key;

            // some operations may take time ... indicate activity with wait.gif
            // var node_to_clear_old_title = node_to_clear.data.title;
            //node_to_clear.setTitle(node_to_clear_old_title + '<img height="30" src="/img/wait.gif" />');

            node_to_clear.removeChildren()

            edit_action_sync(type, currentid, currentid);

        consoledb.log('currentid  :'+currentid);
        consoledb.log('currentpath:'+currentpath);

            $("#hometree").fancytree("getTree").loadKeyPath(currentpath, function(node, status){
                        if(status=="loaded"){
                            node.setExpanded();
                        }else if(status=="ok"){
                            node.setActive();
                        }
                    });

            node_to_clear.setActive();
            var activenode = $("#hometree").fancytree("getTree").activeNode;

            activenode.toggleExpanded();
            activenode.toggleExpanded();

            try {
                node_to_clear.removeChildren();
                node_to_clear.toggleExpanded();
                node_to_clear.toggleExpanded();
                }
            catch(e) {
                consoledb.log('caught exeption :' + e);
                activenode.toggleExpanded();
                activenode.toggleExpanded();
            }
        loadEditArea(key_to_clear);
        consoledb.groupEnd('edit: edit.html: questionOperation('+type+')');

        return false;}

    } else if (type=='delete'){   // never reached?
        var q = $("#mediatum_delete_folder_question").text();

    consoledb.log('currentid  :'+currentid);
    consoledb.log('currentpath:'+currentpath);

    if(confirm(q)){

        var cur_tree = current_tree;
        var key_to_delete = currentid;
        var node_to_delete = cur_tree.getNodeByKey(key_to_delete);
        var parent_node = node_to_delete.getParent();
        var parent_node_key = parent_node.key;

        removeByKey(cur_tree, key_to_delete);

        edit_action_sync(type, currentid, currentid);

    consoledb.log('currentid  :'+currentid);
    consoledb.log('currentpath:'+currentpath);

        cur_tree.loadKeyPath(currentpath, function(node, status){
                    if(status=="loaded"){
                        node.setExpanded(true);
                    }else if(status=="ok"){
                        node.setActive(true);
                    }
                });

        parent_node.setActive(true);
        var activenode = cur_tree.activeNode;
        activenode.toggleExpanded();
        activenode.toggleExpanded();

        try {
            parent_node.removeChild(node_to_delete);
            parent_node.toggleExpanded();
            parent_node.toggleExpanded();
            }
        catch(e) {
            consoledb.log('caught exeption :' + e);
            activenode.toggleExpanded();
            activenode.toggleExpanded();
        }
        htree = gethometree();
        trashdir_key = user_folders.trashdir;
        trashdir = htree.getNodeByKey(trashdir_key);
        trashdir.addChildren(node_to_delete);
        trashdir.load(forceReload=true);
    consoledb.groupEnd('edit: edit.html: questionOperation('+type+')');
    return false;}}
}


function cancelOperation(){
    action = "";
    tree.$(".mediatum_buttonmessage").html('');
}

function addItem(id, path){  // currently unused
    action = "";
    idselection = "";
    consoledb.log(path);
    $('.ui-layout-center').attr('src', '/edit/edit_content?id='+id+"&upload=visible&r="+""+Math.random()*10000);
    $('.mediatum_accordiontree').accordion("option", "active", 0);
    $("#hometree").fancytree("getTree").loadKeyPath(path, function(node, status){
        if(status=="loaded"){
            node.setExpanded();
        }else if(status=="ok"){
            node.setActive();
        }else{
            var seg = arguments[2], isEndNode = arguments[3];
        }
    });
    try {
      $("#hometree").fancytree("getActiveNode").reloadChildren();
    }
    catch(e) {
      consoledb.log('tried to reloadChildren(), caught: '+e);
    }
    return false;
}

function loadEditArea(id){
    $('.ui-layout-center').attr('src', '/edit/edit_content?id='+ id);
}

function set_cm_to_default() {
    flag_cut_mode = false;
    consoledb.log('set_cm_to_default: flag_cut_mode =', flag_cut_mode);
}

</script>
</head>
        <body>

          <iframe class="ui-layout-center" tal:attributes="src python:u'/edit/edit_content?id={}&page={}&nodes_per_page={}&sortfield={}&value={}{}'.format(id, page, nodes_per_page,sortfield, value, searchitems)"> </iframe>

            <div class="ui-layout-north">
                <div class="mediatum_logocontainer">

                    <span i18n:translate="sub_header_user">TEXT</span>: <span tal:replace="raw python:user.getName()"/>
                    <span tal:repeat="item python:spc">
                        | <a tal:attributes="href python:item.link; target python:item.target; title python:u'{}_title'.format(item.getName())" i18n:translate="" i18n:attributes="title" tal:content="python:item.getName()">TEXT</a>
                    </span>
                </div>
            </div>
            <h3 class="mediatum_id_h3_editor" >mediaTUM<sup>&reg;</sup> Editor </h3>

            <div class="ui-layout-west">
                <div class="mediatum_subnavigation">

                    <div class="mediatum_subnavigation_1">
                    </div>
                    <div class="mediatum_subnavigation_2" i18n:translate="">
                        <a href="#" tal:attributes="onclick python:u'return reloadPage({},\'{}\')'.format(folders['homedir'][0].id, folders['homedir'][1])"><img class="mediatum_subnavigation_2_img" src="/img/webtree/homeicon.gif" i18n:attributes="title e_folder_homedir" /></a>
                        <a href="#" tal:attributes="onclick python:u'return reloadPage({},\'{}\')'.format(folders['trashdir'][0].id, folders['trashdir'][1])"><img class="mediatum_subnavigation_2_img" src="/img/webtree/trashicon.gif" i18n:attributes="title e_folder_trashdir" /></a>
                        <a href="#" tal:attributes="onclick python:u'return reloadPage({},\'{}\')'.format(folders['uploaddir'][0].id, folders['uploaddir'][1])"><img class="mediatum_subnavigation_2_img" src="/img/webtree/uploadicon.gif" i18n:attributes="title e_folder_uploaddir" /></a>
                        &nbsp;&nbsp;&nbsp;
                    </div>
                </div>

                <div class="mediatum_treecontent" id="tree">
                    <div i18n:translate="select_target_dir" id="select_target_dir">TEXT</div>
                    <div class="mediatum_accordiontree">
                        <h3 class="mediatum_context-menu-home"><a href="#" tal:attributes="onclick python:u'loadEditArea({})'.format(basedirs[0].id)"><span id="homedir" tal:content="python:basedirs[0].getName()" i18n:translate=""/></a></h3>
                        <div class="mediatum_home_content" onmouseover="$(this).scrollTop(-100);">
                            <tal:block tal:condition="python:user.isAdmin()">
                              <label>Filter:</label>
                              <input id="homenodefilter" name="homenodefilter" i18n:attributes="title edit_tree_homenodefilter_tooltip" tal:attributes="value python:homenodefilter" />
                              <button id="id_btn_reload_htree" onclick="reload_htree_filtered(); return false;" i18n:attributes="title edit_tree_filterbutton_tooltip">&times;</button>
                              <span i18n:attributes="title edit_tree_matches_tooltip" id="htree_matches"> </span>
                            </tal:block>
                            <div  class="mediatum_acc_content" id="hometree"> </div>
                        </div>

                        <h3 class="context-menu-collections"><a href="#" tal:attributes="onclick python:u'loadEditArea({})'.format(basedirs[1].id)"><span id="collections" tal:content="python:basedirs[1].getLabel()"/></a></h3>

                        <div class="mediatum_acc_content" id="tree_content">

                            <div id="mediatum_collectionstree"> </div>
                        </div>
                    </div>
                </div>
                <div class="mediatum_treesouth">
                    <div class="mediatum_buttonmessage"> </div>
                </div>
            </div>

            <script tal:content="python:u'var currentid = {};'.format(id)">TEXT</script>
            <script tal:content="python:u'var currentpath = \'/{}\';'.format('/'.join(path[2:]))">TEXT</script>
            <script tal:content="python:u'var currentcpath = \'/{}\';'.format('/'.join(containerpath[1:]))">TEXT</script>

            <script>
               var rct = null;
               //alert(currentpath + ', ' + currentid);
            </script>

            <script> var currentselection="";</script>

            <script tal:content="python:u'var js_edit_layout_togglertip_open = \'{}\';'.format(t(language, 'edit_layout_togglertip_open'))">;</script>
            <script tal:content="python:u'var js_edit_layout_togglertip_closed = \'{}\';'.format(t(language, 'edit_layout_togglertip_closed'))">;</script>
            <script tal:content="python:u'var js_edit_layout_resizertip = \'{}\';'.format(t(language, 'edit_layout_resizertip'))">;</script>
            <script tal:content="python:u'var csrf = \'{}\';'.format(csrf)"> </script>
<script type="text/javascript">

var htree = null;
var ctree = null;

function reload_htree_filtered(homenodefilter) {
  if (!homenodefilter) {
     var homenodefilter = $('#homenodefilter').val();
  }
  var ht = gethometree();

  ht.widget.tree.options.source.data.homenodefilter = homenodefilter;
  ht.reload().done(function(){
    var homedir_key = user_folders['homedir'];
    var homedir = ht.getNodeByKey(homedir_key);
    var match_result = homedir.data.match_result;
    $('#htree_matches').html(match_result);
  }); // .done()
}



  // ############################################################################

  tree_selector = "#hometree";
  tree_node_id_prefix = "tree-node-";
  tree_root_key = "home";  // "home", "root"
  used_tree_selectors = ["#hometree", "#mediatum_collectionstree"];

  function get_used_trees (selector_list) {
     res = selector_list.map(function (selector) {return $(selector).fancytree("getTree")});
     return res;
  }

  function get_tree_opts(tree_selector, tree_node_id_prefix, tree_root_key, tree_root_nid, used_tree_selectors) {
  // options template for tree (htree and ctree)
  tree_opts = {

    autoFocus: false, // Set focus to first child, when expanding or lazy-loading.
    autoCollapse: false, // Automatically collapse all siblings, when a node is expanded.
    //autoScroll: true,
    activeVisible: true, // Make sure, active nodes are visible (expanded).
    clickFolderMode: 1, // 1:activate, 2:expand, 3:activate and expand
    checkbox: false, // Show checkboxes.
    fx: { height: "toggle", duration: 200 }, // Animations, e.g. null or { height: "toggle", duration: 200 }
    idPrefix: tree_node_id_prefix, // Used to generate node id's like <span id="fancytree-id-<key>">.
    generateIds: true,
    minExpandLevel: 1, // 1: root node is not collapsible, 2, .., 4
    //nolink: false, // Use <span> instead of <a> tags for all nodes
    selectMode: 2, // 1:single, 2:multi, 3:multi-hier
    keyboard: FANCYTREE_KEYBOARD, // Support keyboard navigation.
    tabbable: true, // Whole tree behaves as one single control
    titlesTabbable: false, // Node titles can receive keyboard focus
    debugLevel: 1, // 0:quiet, 1:normal, 2:debug
    enableAspx: false, //Accept passing ajax data in a property named `d` (default: true).

    imagePath: '../img/',

    extensions: ["filter"],  //["persist", "filter"],

    filter: {
      mode: "hide"
    },

    createNode: function(event, data){
        consoledb.log('--- tree createNode ---');
        consoledb.log(event);
        consoledb.log(data);
        var iconpath = data.node.data.icon;
        if (iconpath == "") {data.node.data.icon = FANCYTREE_DEFAULT_ICON;}
      },

    source: {
      url: '/edit/treedata',
      type: "POST",
      data: {key: tree_root_key, mode: "edittree", homenodefilter: $('#homenodefilter').val(), csrf_token: csrf},
      dataType: "json"
    },

    loadChildren: function(event, data) {
        data.node.visit(function(subNode){
            if( subNode.isUndefined() && subNode.isExpanded() ) {
                subNode.load();
            }
        });
    },

    // Called when a lazy node is expanded for the first time
    lazyLoad: function(event, data){
        consoledb.log('--- lazyLoad ---');
        consoledb.log(event);
        consoledb.log(data);
        var node = data.node;
        // Load child nodes via ajax


        // synchronous loading
        var ajax_response;
        var options = {
              url: '/edit/treedata?mode=edittree&key='+node.key,
              async: false,
              dataType: 'json',
              success: function (response) {
                  ajax_response = response;
              },
            };
        try {
          $(node.li).addClass('fancytree-loading');
        }
        catch (e) {
         ;
        }
        $.ajax(options);
        data.result = ajax_response;
        try {
          $(node.li).removeClass('fancytree-loading');
        }
        catch (e) {
         ;
        }

    },

    keydown: function(event, data){
      consoledb.log('--- keydown ---');
      consoledb.log('event:', event);
      consoledb.log('event.key:', "'"+event.key+"'",'event.altKey:', event.altKey,'event.ctrlKey:', event.ctrlKey,'event.metaKey:', event.metaKey);
      consoledb.log('data:', data);

      // Eat keyboard events, when a menu is open
      if( $(".context-menu-item:visible").length > 0 ) {
        consoledb.log('detected ctx-menu');

        // give keyboard focus to context menu; disable keyboard fo tree
        $('.context-menu-list .context-menu-root').focus();
        current_tree.widget.options.keyboard = false;

        return;
        }
        else{
          current_tree.widget.options.keyboard = FANCYTREE_KEYBOARD;
        }

      var node = data.node;
      if(event.key=="Enter" && node.data.readonly==0 && action==""){
          idselection = node.key;
          loadEditArea(node.key);
      }
      if(event.key==" " && node.data.readonly==0 && action==""){
          // 2014-11-26
          contextmenue_on_demand('#'+tree_node_id_prefix+data.node.key, $(tree_selector).fancytree("getTree"), tree_node_id_prefix, data.node);  // tree-dependent
          $('#'+tree_node_id_prefix+node.key+' span').contextMenu(); // show contextmenu programatically
        $('.context-menu-list .context-menu-root').focus();
        current_tree.widget.options.keyboard = false;
      }
      if(event.key=="Del" && node.data.readonly==0 && action==""){
          consoledb.log('going to remove active node');
          current_tree = $(this).fancytree("getTree");
          currentid = current_tree.activeNode.key;
          questionOperation('delete'); // removes active node
      }
      if(event.key=="Esc" && event.altKey==false && event.ctrlKey==false && event.metaKey==false) {
          consoledb.log('Esc key pressed');
          hideContextMenuForNode(node);
          set_cm_to_default();
          action = "";
          try {
            node_to_paste.li.className = node_to_paste_classname;
          }
          catch(e) {
          ;
          }
      }

      switch( event.which ) {

        case 67:
          if( event.ctrlKey ) { // Ctrl-C
            copyPaste("copy", node);
            return false;
          }
          break;
        case 86:
          if( event.ctrlKey ) { // Ctrl-V
            copyPaste("paste", node);
            return false;
          }
          break;
        case 88:
          if( event.ctrlKey ) { // Ctrl-X
            copyPaste("cut", node);
            return false;
          }
          break;
      }

    },  // keydown:

    // event click is fired befor activate
    click: function(event, data){
      var click_target_type = data.targetType;
      consoledb.log('#### click ####: ', click_target_type);
      consoledb.log(event);
      consoledb.log('event.type: ' + event.type);
      consoledb.log('action click: ', action);
      last_click_event = event;

      node = data.node;
      consoledb.log(data);
      consoledb.log('---> node.data.readonly: ' + node.data.readonly);
      current_tree = $(this).fancytree("getTree");
      current_tree.widget.options.keyboard = FANCYTREE_KEYBOARD;
      currentpath = node.getKeyPath();
      tree.currentfolder = node.key;

      if(event.type=="fancytreeclick" && node.data.readonly==0 && action==""){
          idselection = node.key;
          loadEditArea(node.key);
      }
      else if (click_target_type == 'title' || click_target_type == 'icon') {

        consoledb.groupCollapsed('tree onClick with action');
        consoledb.log('action: '+action);

        var url = '&action='+encodeURIComponent(action);

        if (action=="move" || action=="copy"){
            url = '&action='+encodeURIComponent(action)+'&dest='+node.key;
        }

        var ajax_response;

        var options = {
              url: '/edit/edit_action?src='+idselection+'&ids='+currentselection+'&style=popup'+url,
              async: false,
              dataType: 'json',
              success: function (data) {
                consoledb.log('entering callback function ...');
                if (data!=""){
                  var msg = '-- after action: '+action+' --: '+data;
                  consoledb.log(msg);
                  ajax_response = data;
                  ctree = getcoltree();  // ???  // more general solution needed ?
                  htree = gethometree();
                  if ('changednodes' in data) {
                    var changednodes = data.changednodes;
                    for (key in changednodes) {
                      consoledb.log(key);
                      consoledb.log(changednodes[key]);
                      var changed_node = ctree.getNodeByKey(key);
                      if (changed_node) {
                        changed_node.title = changednodes[key];
                        changed_node.renderTitle();
                      }
                      changed_node = htree.getNodeByKey(key);
                      if (changed_node) {
                        changed_node.title = changednodes[key];
                        changed_node.renderTitle();
                      }
                    }
                  }  // if ('changednodes' in data)

                action = "";
                loadEditArea(node.key);

                }  // if (data!="")

                return false;
              }  // function (data)

            };  // options:

        $.ajax(options);
        consoledb.groupEnd('tree onClick');
      }  // else if
    },  // click:

    activate: function(event, data) {
      consoledb.log('--- activate ---', data.node.title, data.node.key);
      consoledb.log(event);
      consoledb.log(data);
      var node = data.node;

      if (node.data.readonly == 1) {return;}

      last_activated_tree_id_sel = tree_selector;
      current_tree = $(this).fancytree("getTree");
      current_tree.widget.options.keyboard = FANCYTREE_KEYBOARD;
      idselection = node.key;
      // Close menu on click
      currentpath = node.getKeyPath();
      idselection = node.key;
      tree.currentfolder = node.key;
      // 2014-11-26
      contextmenue_on_demand('#'+tree_node_id_prefix+data.node.key, $(tree_selector).fancytree("getTree"), tree_node_id_prefix, data.node);  // tree-dependent
      $(node.span).removeClass('disabled');
      if( $(".contextMenu:visible").length > 0 ){
        $(".contextMenu").hide();
      }

      last_activated_node = last_activated_hometree_node = node;

      if(event.type=="fanytreeclickactivate" && node.data.readonly==0 && action==""){
          idselection = node.key;
          loadEditArea(currentid);
      };

      if (flag_cut_mode) {
        disable_tree_nodes(get_used_trees(used_tree_selectors), [node_to_paste.key]);
      }
    },  // activate:

    init: function(isReloading, isError){
        if (currentpath!="/"){
            $(this).fancytree("getTree").loadKeyPath(currentcpath, function(node, status){
                if(status=="loaded"){ ;
                }else if(status=="ok"){
                    node.setActive({noEvents: true});  // prevent folder content from being reloaded
                }
            });
        }
    },

    postProcess: function(event, data) {  // check this
        consoledb.log('--- tree postProcess ---');
        consoledb.log('event:', event, 'data:', data);
        data.tree.rootNode.setTitle(tree_root_nid);
        if (currentpath!="/"){
            //var node = data.node;
            var thistree = $(tree_selector).fancytree("getTree");
            thistree.loadKeyPath(currentpath, function(node, status){
                if(status=="loaded"){
                    node.setExpanded();
                }else if(status=="ok"){
                    node.setActive();
                }
            });
        }
    }  // postProcess:

  }; // tree_opts

  return tree_opts;

  }


$(document).ready(function () {
  consoledb.log('document ready function #002');

  $('.context-menu-collections').on('click', function(e){
      consoledb.log('clicked context-menu-collections', this);
  })

  layout = $('body').layout({
          applyDemoStyles: true,
          center__maskContents: true,
          north: {closable:false, resizable:false, spacing_open: 0, spacing_closed: 0, size:30},
          south: {closable:false, resizable:false, spacing_open: 0, spacing_closed: 0, size:20},
          west: {size:300,onresize: $.layout.callbacks.resizePaneAccordions,
              childOptions: {
                  spacing_open: 0,
                  spacing_closed:0,
                  north: {paneSelector: ".mediatum_subnavigation", size:30},
                  center:{paneSelector: ".mediatum_treecontent", onresize: $.layout.callbacks.resizePaneAccordions},
                  south:{paneSelector:  ".mediatum_treesouth", closable:false, resizable:false, spacing_open: 0, spacing_closed: 0, size:21}
              }

          },
          resizerTip: js_edit_layout_resizertip,
          togglerTip_open: js_edit_layout_togglertip_open,
          togglerTip_closed: js_edit_layout_togglertip_closed
  });

  $(".mediatum_accordiontree").accordion({
      heightStyle: "fill", active: 1
  });



  // create home tree
  htree = $("#hometree").fancytree(get_tree_opts("#hometree", "htree-node-", "home", "INVALID", ["#hometree", "#mediatum_collectionstree"]));

  // create collections tree
  ctree = $("#mediatum_collectionstree").fancytree(get_tree_opts("#mediatum_collectionstree", "ctree-node-", "root", collectionsid, ["#hometree", "#mediatum_collectionstree"]));

  // close context menu when mouse is leaving pane
  var triggertarget = layout.panes.center;
  triggertarget.on('mouseover', function() {hideContextMenuForNode(last_activated_node);})

});  // $(document).ready(...)


function __load(path){
    consoledb.log('called edit.html: __load(path)');
    $("#mediatum_collectionstree").fancytree("getTree").loadKeyPath(path, function(node, status){
            consoledb.log('load');

            if(status=="loaded"){
                //node.toggleExpanded(); //expand();
                //node.toggleExpanded();
                node.setExpanded();
            }else if(status=="ok"){
                node.setActive();
            }else{
                var seg = arguments[2], isEndNode = arguments[3];
                consoledb.log(seg);
            }
        });
}

// reload collections tree
function rct() {
          consoledb.group('edit.html: rct()');
          consoledb.log('currentpath: '+ currentpath);
          ctree = getcoltree();
          consoledb.log('acquired ctree');
          htree = gethometree();
          consoledb.log('acquired htree');
          if (current_tree == ctree) {
              consoledb.log('true: current_tree == ctree');
              $("#mediatum_collectionstree").fancytree("getTree").reload();
          }
          if (current_tree == htree) {
              consoledb.log('true: current_tree == htree');
              $("#hometree").fancytree("getTree").reload();
              consoledb.log('htree reloaded');
              consoledb.log('loaded key path');
          }
          consoledb.groupEnd('edit.html: rct()');
      };


</script>
            <!-- Definition of context menu -->
            <tal:block tal:repeat="ct_iconpath cmenu_iconpaths">
                <style tal:content="python: '.context-menu-item.icon-%s { background-image: url(img/%s); }' % (ct_iconpath[0], ct_iconpath[2])">#</style>
            </tal:block>

            <div id="mediatum_clear_trash_question" i18n:translate="clear_trash_question"> </div>
            <div id="mediatum_delete_folder_question" i18n:translate="delete_folder_question"> </div>
            <div id="select_target_dir" >
               <tal:block i18n:translate="select_target_dir"/>&nbsp;&nbsp;&nbsp;
               <a href="#" tal:attributes="onclick python:'parent.cancelOperation()'"><img src="/img/delete.png" i18n:attributes="title edit_publish_cancel"/></a>&nbsp;
            </div>

        </body>
    </html>
</metal:block>


<div metal:define-macro="edit_paging" class="mediatum_edit_paging">
    <div tal:condition="python:previd" id="previd">
        <a tal:attributes="href python:u'/edit/edit_content?id={}&tab={}'.format(previd, tab)"><img border="0" src="/img/pageleft.gif"/></a>
    </div>
    <div tal:condition="python:previd or nextid" id="orid" >
        <tal:block tal:replace="raw script"/>
        <select id="goto" tal:attributes="onchange python:u'gotoContent(document.getElementById(\'goto\').value,\'{}\')'.format(tab)">
            <option tal:repeat="item combodata" tal:attributes="value python:item[0]; selected python:[None,'selected'][item[0]==nodeid]" tal:content="python:item[1]" ></option>
        </select>
        / <tal:block tal:replace="absitems" />
    </div>
    <div tal:condition="python:nextid" id="nextid">
         <a tal:attributes="href python:u'/edit/edit_content?id={}&tab={}'.format(nextid, tab)"><img border="0" src="/img/pageright.gif"/></a>
    </div>
</div>

<metal:block metal:define-macro="edit_paging_combo"> </metal:block>

<html metal:define-macro="edit_action_error">
    <body>
        <h1 i18n:translate="edit_error">TEXT</h1>
        <i i18n:translate="edit_nobase">TEXT<span tal:content="edit_action_error" i18n:name="msg"/></i>
    </body>
</html>


<html metal:define-macro="edit_action_new_error">
    <head>
        <script language="text/javascript">
            opener.reloadURL('edit?id="""+node.id+"""');
        </script>
    </head>
    <body>
        <h2 i18n:translate="edit_error">TEXT</h2>
        <span i18n:translate="edit_create_new_folder">TEXT</span>
    </body>
</html>


<i metal:define-macro="access_error" i18n:translate="edit_access_error">TEXT</i>


<metal:block metal:define-macro="frame_content">
    <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
    <html>
        <head>
            <meta http-equiv="X-UA-Compatible" content="IE=9"/>
            <META http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
            <meta content="text/html;charset=UTF-8" http-equiv="content-type"/>
            <link rel="stylesheet" href="/css/jquery-ui-1.12.1.css" />
            <link rel="stylesheet" href="/css/editor.css" />

            <script type="text/javascript" src="/js/jquery-2.0.3.js"> </script>
            <script type="text/javascript" src="/js/jquery-ui-1.12.1.js"> </script>
            <script type="text/javascript" src="/js/jquery.layout.min.js"> </script>
            <script type="text/javascript" src="/js/jquery.layout.resizePaneAccordions-latest.min.js"> </script>
            <script type="text/javascript" src="/js/editor.js"> </script>
            <script type="text/javascript" src="/js/admin.js"> </script>

            <script type="text/javascript" src="/js/mediatum.js"> </script>
            <script type="text/javascript" tal:content="python:U'var tab=\'{}\';'.format(tab)"/>
            <script type="text/javascript">
                var allobjects = new Array();

                function getAllObjectsString(){
                    var s = [];
                    $('input[id^="check"]:checked').each(function(){
                        var nodeid = $(this).attr('id').substring(5);
                        if (nodeid != 'node.id' & ! (s.includes(nodeid))){
                            s.push(nodeid);
                        }
                    });
                    return s.join(',');
                }

                function Thumb2Window(id){
                    var win1 = window.open('/thumbbig?id='+id,'thumbbig','width=100,height=100,directories=no,location=no,menubar=no,scrollbars=no,status=no,toolbar=no,resizable=1');
                    win1.focus();
                    return false;
                }

                var sublayout;
            </script>
            <tal:block tal:replace="script"/>
        </head>

        <body id="body">

            <div id="navigation">
                <tal:block tal:replace="raw tabs"/>

                <!-- operations-->
                <div id="mediatum_operations" tal:condition="python:len(ids)==1" tal:content="raw operations">TEXT</div>

                <!-- breadcrumbs-->
                    <div class="mediatum_breadcrumbs_nav">
                    <div class="mediatum_breadcrumbs_link"><b i18n:translate="edit_actual_dir" class="mediatum_breadcrumbs_padding">TEXT</b></div>
                    <div class="mediatum_breadcrumbs_content" tal:content="raw dircontent"> </div>
                    <!-- nav-->
                    <div class="mediatum_divnav"  tal:content="raw paging"> </div>
                </div>

            </div>

            <div id="sub_content" >
                <tal:block tal:replace="raw body"/>
            </div>

            <script tal:content="python:u'var js_edit_layout_togglertip_open = \'{}\';'.format(t(language, 'edit_layout_togglertip_open'))">;</script>
            <script tal:content="python:u'var js_edit_layout_togglertip_closed = \'{}\';'.format(t(language, 'edit_layout_togglertip_closed'))">;</script>
            <script tal:content="python:u'var js_edit_layout_resizertip = \'{}\';'.format(t(language, 'edit_layout_resizertip'))">;</script>

            <script>
                $(document).ready(function () {
                    $('body').layout({

                    north: {paneSelector: "#navigation", closable:false, resizable:false, spacing_open: 0, showOverflowOnHover: true,
                           /*childOptions: {
                            center__paneSelector: "#selection",
                            south__paneSelector: "#navigation_content",
                            },*/
                        },

                    south: {paneSelector: "#sub_footer", closable:false, resizable:false, spacing_open: 0, spacing_closed: 0, size:60},
                    center:{paneSelector: "#sub_content"},
                        resizerTip: js_edit_layout_resizertip,
                        togglerTip_open: js_edit_layout_togglertip_open,
                        togglerTip_closed: js_edit_layout_togglertip_closed
                    });

                });

                function closeOverlay(){
                    $('#overlay').hide();
                }

                function showOverlay(){
                    $('#overlay').show();
                }
            </script>
            <!--content end-->
            <div class="mediatum_wait_"><img src="/img/wait.gif"/></div>

        <div id="overlay">
            <div id="background"> </div>

            <div id="text">
            </div>
        </div>

        </body>
    </html>
</metal:block>


<metal:block metal:define-macro="error">
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "DTD/xhtml1-transitional.dtd">
    <html>
        <head>
            <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
            <meta content="text/html;charset=UTF-8" http-equiv="content-type">
            <link rel="stylesheet" href="/css/editor.css" />
        </head>
        <body>
            <div id="mediatum_logocontainer">
                &nbsp;
            </div>
            <div class="topmenucontainer">
                <span>&nbsp;</span>
            </div>
            <div class="mediatum_MainMenu">
                <br/>
                <br/>
                <p i18n:translate="edit_error_msg" class="error">TEXT
                    <span i18n:name="link"><a i18n:translate="edit_linktext" href="../login" target="_parent">TEXT</a></span>
                </p>
            </div>
        </body>
    </html>
</metal:block>


<tal:block metal:define-macro="itemlist">
    <div id="items" >
        <tal:block tal:repeat="item nodes">
            <a href="#" tal:attributes="onclick python:u'return Thumb2Window({})'.format(item.id)"><img tal:attributes="src python:u'/thumbs/{}'.format(item.id)" style="width:80px;"/></a>
        </tal:block>
    </div>
</tal:block>
